<!DOCTYPE html>
<html lang="ru">
<head>
	<!-- Meta -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<!-- Open Graph -->
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="Борин хоумпэйдж">
	<meta property="og:title" content="??? Страничка с календарями ???">
	<meta property="og:description" content="??? описание ???">
	<meta property="og:url" content="https://ovodov.me/events">
	<meta property="og:image" content="static/favicon-20231123.png" />
	<meta property="og:locale" content="ru_RU" />

	<!-- Static -->
	<link rel="stylesheet" type="text/css" href="static/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="static/style20231103.css">
	<link rel="shortcut icon" href="static/favicon-20231123.png">
	<style>
		#telegram-message {
			display: none;
			font-size: 18px;
			margin: 20px;
		}
	</style>

	<script src="static/bootstrap.min.js"></script>
	
	<title>??? название страницы ???</title>
</head>
<body>
	<div id="telegram-message">
		<p>Пожалуйста, нажмите кнопку «Открыть в Safari», чтобы добавить событие в календарь.</p>
	</div>

	<script>
		function isTelegramInAppBrowser() {
			if (navigator.userAgent.includes("Android") && typeof window.TelegramWebview !== "undefined") {
				return true;
			}
			if (navigator.userAgent.includes("iPhone") && typeof window.TelegramWebviewProxy !== "undefined" && typeof window.TelegramWebviewProxyProto !== "undefined") {
				return true;
			}
			return false;
		}

		function formatICSDate(dateStr) {
			const date = new Date(dateStr);
			return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
		}

		function generateICS() {
			const params = new URLSearchParams(window.location.search);
			const event = {
				uuid: crypto.randomUUID(),
				title: params.get("summary"),
				location: params.get("location"),
				start: params.get("start"),
				end: params.get("end"),
				url: params.get("url"),
			};

			return `
BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//Apple Inc.//macOS 15.5//RU

BEGIN:VTIMEZONE
TZID:Asia/Yekaterinburg
X-LIC-LOCATION:Asia/Yekaterinburg
BEGIN:STANDARD
TZOFFSETFROM:+0500
TZOFFSETTO:+0500
TZNAME:+05
DTSTART:19700101T000000
END:STANDARD
END:VTIMEZONE

BEGIN:VEVENT
UID:${event.uuid}
DTSTART;TZID=Asia/Yekaterinburg:${formatICSDate(event.start)}
DTEND;TZID=Asia/Yekaterinburg:${formatICSDate(event.end)}
DTSTAMP:20250101T010000
SUMMARY:${event.summary}
LOCATION:${event.location}
URL;VALUE=URI:${event.url}
END:VEVENT

END:VCALENDAR`.trim();
		}

		function downloadICS(content) {
			const blob = new Blob([content], { type: "text/calendar" });
			const url = URL.createObjectURL(blob);

			const a = document.createElement("a");
			a.href = url;
			a.download = "event.ics";
			a.click();

			URL.revokeObjectURL(url);
		}

		window.addEventListener("DOMContentLoaded", () => {
			if (isTelegramInAppBrowser()) {
				document.getElementById("telegram-message").style.display = "block";
			} else {
				const content = generateICS();
				downloadICS(content);
			}
		});
	</script>
</body>
</html>